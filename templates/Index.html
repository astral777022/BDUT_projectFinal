{% extends "base.html" %}

{% block title %}
	–ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
{% endblock %}

{% block content %}
	<header class="header" id="header">
		<div class="container">
			<div class="row d-flex align-items-center">	
				<div class="col-3 col-md-4 col-lg-2">
		  			<a href="index">
						<img class="img-fluid logo" src="{{url_for('static', filename='img/low.png')}}" alt="logo">
		  			</a>
				</div>
				<!-- –ü–æ–ª–µ –ø–æ—à—É–∫—É -->
				<div class="col-9 serh d-lg-flex col-md-8 col-lg-7 flex items-center">
					<div class="search-wrapper">
					  	<input type="text" placeholder="–ü–æ—à—É–∫..." class="search-input" />
					  	<button class="search-button">üîç</button>
					</div>
				</div>
				<div class="col-12 reg-in col-md-12 d-lg-flex col-lg-3 justify-content-end align-items-center menu-collapse">
		  			<!-- –ú–µ–Ω—é -->
		  			<nav class="menu">
						<ul class="menu__list d-flex">
							<li class="menu__item">
								<a class="menu__registr" href="#">–†–µ–µ—Å—Ç—Ä–∞—Ü—ñ—è</a>
							</li>
							<li class="menu__item">
								<a class="menu__exit" href="#">–í—Ö—ñ–¥</a>
							</li>
						</ul>
		  			</nav>
				</div>
			</div>
		</div>
	</header>

	<section class="offer" id="offer" data-type="background" data-speed="5">
		<div class="header-back"></div>
		<div class="back"></div>
		<div class="container">
			<div class="row">
				<div class="col-12">
					<h1 class="offer-title">
						–ö–æ–º—É–Ω–∞–ª—å–Ω–∏–π –∑–∞–∫–ª–∞–¥ <br>
						"–¢–∞—Ç–∞—Ä–±—É–Ω–∞—Ä—Å—å–∫–∏–π –±—É–¥–∏–Ω–æ–∫ –¥–∏—Ç—è—á–æ—ó —Ç–∞ —é–Ω–∞—Ü—å–∫–æ—ó —Ç–≤–æ—Ä—á–æ—Å—Ç—ñ" <br>
						–¢–∞—Ç–∞—Ä–±—É–Ω–∞—Ä—Å—å–∫–æ—ó  –º—ñ—Å—å–∫–æ—ó  —Ä–∞–¥–∏  –û–¥–µ—Å—å–∫–æ—ó  –æ–±–ª–∞—Å—Ç—ñ
					</h1>
					<p class="offer-desc">
						–ë—É–¥–∏–Ω–æ–∫ —Ç–≤–æ—Ä—á–æ—Å—Ç—ñ, –Ω–∞—à —Ä—ñ–¥–Ω–∏–π –¥—ñ–º,<br>
						–ì–æ—Å—Ç–∏–Ω–Ω–æ –¥–≤–µ—Ä—ñ —Ç–∏ –Ω–∞–º –≤—ñ–¥—á–∏–Ω—è—î—à.<br>
						–ó—ñ–≥—Ä—ñ—Ç—ñ –º–∏ –ª—é–±–æ–≤‚Äô—é —ñ —Ç–µ–ø–ª–æ–º —Ç–≤–æ—ó–º,<br>
						–ü—Ä–µ–∫—Ä–∞—Å–Ω–∏–º–∏ –ª—é–¥—å–º–∏<br>
						–£ —Å—Ç—ñ–Ω–∞—Ö —Ü–∏—Ö –∑—Ä–æ—Å—Ç–∞—î–º.
					</p>
				</div>
			</div>
		</div>
	</section>

	<section class="cal">
		<div class="container">
			<div class="row">
				<div class="center d-flex col-sm-12 col-md-6"> 
					<div class="calendar-wrapper">
						<div class="calendar-header">
							<button id="btnPrev" type="button">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π</button>
							<span id="monthYear"></span>
							<button id="btnNext" type="button">–ù–∞—Å—Ç—É–ø–Ω–∏–π</button>
						</div>
						<div id="divCal" class="calendar-table"></div>
						<div class="calendar-buttons">
							<a href="#" class="podii-2">–í—Å—ñ –ø–æ–¥—ñ—ó —Ü—å–æ–≥–æ –º—ñ—Å—è—Ü—è</a>
						</div>
					</div>
				</div>
				<div class="d-flex col-sm-12 col-md-6 main-slide m-auto">
					<div class="slide-block">
						<img src="{{url_for('static', filename='img/photo_2024-12-26_23-22-22.jpg')}}" class="slide-block__img">
					</div>
					<div class="slide-block">
						<img src="{{url_for('static', filename='img/002.jpg')}}" class="slide-block__img">
					</div>
					<div class="slide-block">
						<img src="{{url_for('static', filename='img/003.jpg')}}" class="slide-block__img">
					</div>
				</div>
			</div>
		</div>
	</section>
{% endblock %}

{% block ModalWindows %}
	<!-- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ -->
	<div style="display: none;"> <!-- –í—ñ–∫–Ω–æ —Ä–µ–µ—Å—Ç—Ä–∞—Ü—ñ—ó -->
		<div class="box-modal" id="exampleModal-1">
			<div class="box-modal_close arcticmodal-close">
				<img src="{{url_for('static', filename='img/close.png')}}">
			</div>
			<form method="POST" action="{{ url_for('register') }}" class="modal-1__form d-flex flex-column js-form" id="popupResult-1">
				<div class="modal-1__block-input d-flex flex-column">
					<input id="login-f1" class="modal-input" type="text" name="login" placeholder="–õ–æ–≥—ñ–Ω" required>
					<input id="name-f1" class="modal-input" type="text" name="name" placeholder="–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞" required>
					<input id="surname-f1" class="modal-input" type="text" name="surname" placeholder="–ü—Ä–∏–∑–≤—ñ—â–µ" required>
					<input id="tel-f1" class="modal-input" type="text" name="tel" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
					<select name="clas" class="class"  required>
						<option value="0">–û–±–µ—Ä—ñ—Ç—å –∫–ª–∞—Å!</option>
						<option value="1">–ö–ª–∞—Å 1</option>
						<option value="2">–ö–ª–∞—Å 2</option>
						<option value="3">–ö–ª–∞—Å 3</option>
						<option value="4">–ö–ª–∞—Å 4</option>
						<option value="5">–ö–ª–∞—Å 5</option>
						<option value="6">–ö–ª–∞—Å 6</option>
						<option value="3">–ö–ª–∞—Å 7</option>
						<option value="4">–ö–ª–∞—Å 8</option>
						<option value="5">–ö–ª–∞—Å 9</option>
						<option value="6">–ö–ª–∞—Å 10</option>
						<option value="6">–ö–ª–∞—Å 11</option>
					</select>
					<p class="radio-text">–•—Ç–æ –≤–∏?<br>–ó—Ä–æ–±—ñ—Ç—å —Å–≤—ñ–π –≤–∏–±—ñ—Ä!</p>
					<select name="role" class="class" required>
						<option value="student">–£—á–µ–Ω—å</option>
						<option value="parent">–ë–∞—Ç—å–∫–∏</option>
					</select>

					<input type="password" id="pass-f1" class="modal-input" name="password" minlength="6" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" required>
					<button class="button modal-button" type="data-submit">–†–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
				</div>
			</form>
		</div>
	</div>

	<div style="display: none;"> <!-- –í—ñ–∫–Ω–æ –≤—Ö–æ–¥—É -->
		<div class="box-modal" id="exampleModal-2">
			<div class="box-modal_close arcticmodal-close"><img src="{{url_for('static', filename='img/close.png')}}" class="close"></div>
			<form action="/success.php" class="modal-2__form d-flex flex-column js-form" id="popupResult-2">
				<div class="modal-2__block-input d-flex flex-column">
					<input id="name-f2" class="modal-input" type="text" name="login" placeholder="–í–∞—à e-mail">
					<input type="password" id="pass-f2" class="modal-input" name="password" minlength="6" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
				</div>
				<button class="button modal-button" data-submit>–£–≤—ñ–π—Ç–∏</button>
			</form>
		</div>
	</div>

	<div style="display: none;">
		<div class="box-modal" id="exampleModal-3">
			<div class="box-modal_close arcticmodal-close"><img src="{{url_for('static', filename='img/close.png')}}" class="close"></div>
			<div>
				<div class="date">
					<p id="selectedDate"></p>
				</div>
				<div class="desc-date" id="eventDetails">
					<p>–ü–æ–¥—ñ—ó –≤—ñ–¥—Å—É—Ç–Ω—ñ</p>
				</div>
			</div>
		</div>
	</div>

	<div style="display: none;">
		<div class="box-modal" id="exampleModal-4">
			<div class="box-modal_close arcticmodal-close"><img src="{{url_for('static', filename='img/close.png')}}" class="close"></div>
			<div class="date">
				<p id="currentMonth"></p>
			</div>
			<ul class="list-event" id="eventList"></ul>
		</div>
	</div>

	<script type="text/javascript">
		var Cal = function(divId) {
			this.divId = divId;
			this.DaysOfWeek = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–ù–¥'];
			this.Months = ['–°—ñ—á–µ–Ω—å', '–õ—é—Ç–∏–π', '–ë–µ—Ä–µ–∑–µ–Ω—å', '–ö–≤—ñ—Ç–µ–Ω—å', '–¢—Ä–∞–≤–µ–Ω—å', '–ß–µ—Ä–≤–µ–Ω—å', '–õ–∏–ø–µ–Ω—å', '–°–µ—Ä–ø–µ–Ω—å', '–í–µ—Ä–µ—Å–µ–Ω—å', '–ñ–æ–≤—Ç–µ–Ω—å', '–õ–∏—Å—Ç–æ–ø–∞–¥', '–ì—Ä—É–¥–µ–Ω—å'];
			var d = new Date();
			this.currMonth = d.getMonth();
			this.currYear = d.getFullYear();
			this.currDay = d.getDate();
			this.events = [];
		};

		Cal.prototype.fetchEvents = async function() {
			try {
				const response = await fetch('/api/events', {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				});
				this.events = await response.json();
				console.log('–ü–æ–¥—ñ—ó –∑ API:', this.events);
			} catch (error) {
				console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –ø–æ–¥—ñ–π:', error);
			}
		};

		Cal.prototype.nextMonth = function() {
			if (this.currMonth == 11) {
				this.currMonth = 0;
				this.currYear = this.currYear + 1;
			} else {
				this.currMonth = this.currMonth + 1;
			}
			this.showcurr();
		};

		Cal.prototype.previousMonth = function() {
			if (this.currMonth == 0) {
				this.currMonth = 11;
				this.currYear = this.currYear - 1;
			} else {
				this.currMonth = this.currMonth - 1;
			}
			this.showcurr();
		};

		Cal.prototype.showcurr = function() {
			this.showMonth(this.currYear, this.currMonth);
		};

		Cal.prototype.showMonth = function(y, m) {
			var d = new Date();
			var firstDayOfMonth = new Date(y, m, 7).getDay();
			var lastDateOfMonth = new Date(y, m + 1, 0).getDate();
			var lastDayOfLastMonth = m == 0 ? new Date(y - 1, 11, 0).getDate() : new Date(y, m, 0).getDate();

			// –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–∑–≤—É –º—ñ—Å—è—Ü—è —Ç–∞ —Ä–æ–∫—É
			document.getElementById('monthYear').textContent = this.Months[m] + ' ' + y;

			var html = '<table>';
			html += '<tr class="days">';
			for (var i = 0; i < this.DaysOfWeek.length; i++) {
				html += '<td>' + this.DaysOfWeek[i] + '</td>';
			}
			html += '</tr>';

			var i = 1;
			do {
				var dow = new Date(y, m, i).getDay();
				if (dow == 1) {
					html += '<tr>';
				} else if (i == 1) {
					html += '<tr>';
					var k = lastDayOfLastMonth - firstDayOfMonth + 1;
					for (var j = 0; j < firstDayOfMonth; j++) {
						html += '<td class="not-current">' + k + '</td>';
						k++;
					}
				}

				var currentDate = new Date(y, m, i);
				var eventsForDay = this.events.filter(event => {
					var eventDate = new Date(event.date);
					return eventDate.getFullYear() === y &&
						   eventDate.getMonth() === m &&
						   eventDate.getDate() === i;
				});

				var hasEvent = eventsForDay.length > 0;
				var isPastEvent = false;
				if (hasEvent) {
					const now = new Date();
					isPastEvent = eventsForDay.every(event => {
						const eventDate = new Date(event.date);
						return eventDate < now;
					});
				}

				var chk = new Date();
				var chkY = chk.getFullYear();
				var chkM = chk.getMonth();
				if (chkY == this.currYear && chkM == this.currMonth && i == this.currDay) {
					html += `<td class="today${hasEvent ? (isPastEvent ? ' past-event-day' : ' event-day') : ''}"><a href="#" class="but-block but-block-${i}" onclick="calendarInstance.showDayEvents(${y}, ${m}, ${i}); return false;">${i}</a></td>`;
				} else {
					html += `<td class="normal${hasEvent ? (isPastEvent ? ' past-event-day' : ' event-day') : ''}"><a href="#" class="but-block but-block-${i}" onclick="calendarInstance.showDayEvents(${y}, ${m}, ${i}); return false;">${i}</a></td>`;
				}

				if (dow == 0) {
					html += '</tr>';
				} else if (i == lastDateOfMonth) {
					var k = 1;
					for (dow; dow < 7; dow++) {
						html += '<td class="not-current">' + k + '</td>';
						k++;
					}
				}
				i++;
			} while (i <= lastDateOfMonth);

			html += '</table>';
			document.getElementById(this.divId).innerHTML = html;
		};

		Cal.prototype.showDayEvents = function(year, month, day) {
			const selectedDate = new Date(year, month, day);
			const dayOfWeek = this.DaysOfWeek[selectedDate.getDay() === 0 ? 6 : selectedDate.getDay() - 1];
			const dateStr = `${day} ${this.Months[month].toUpperCase()} ${year} - ${dayOfWeek}`;
			document.getElementById('selectedDate').textContent = dateStr;

			const eventsOnDay = this.events.filter(event => {
				const eventDate = new Date(event.date);
				return eventDate.getFullYear() === year &&
					   eventDate.getMonth() === month &&
					   eventDate.getDate() === day;
			});

			const eventContainer = document.getElementById('eventDetails');
			eventContainer.innerHTML = '';

			if (eventsOnDay.length > 0) {
				eventsOnDay.forEach(event => {
					const eventDate = new Date(event.date);
					const timeStr = eventDate.toTimeString().slice(0, 5);
					const eventHtml = `
						<div>
							<h2 class="event-title">${event.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</h2>
							<p class="event-desc">–ß–∞—Å –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è: ${timeStr}</p>
						</div>
					`;
					eventContainer.innerHTML += eventHtml;
				});
			} else {
				eventContainer.innerHTML = `
					<p>–ù–µ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –Ω—ñ—è–∫–∏—Ö –ø–æ–¥—ñ–π</p>
				`;
			}

			try {
				$.arcticmodal({
					content: '#exampleModal-3'
				});
			} catch (error) {
				console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ (#exampleModal-3):', error);
				alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
			}
		};

		Cal.prototype.showAllEvents = function() {
			document.getElementById('currentMonth').textContent = 
				this.Months[this.currMonth] + ' ' + this.currYear;

			const eventList = document.getElementById('eventList');
			eventList.innerHTML = '';

			const daysInMonth = new Date(this.currYear, this.currMonth + 1, 0).getDate();

			for (let day = 1; day <= daysInMonth; day++) {
				const eventsForDay = this.events.filter(event => {
					const eventDate = new Date(event.date);
					return eventDate.getFullYear() === this.currYear &&
						   eventDate.getMonth() === this.currMonth &&
						   eventDate.getDate() === day;
				});

				const li = document.createElement('li');
				li.classList.add('event-item');
				if (eventsForDay.length > 0) {
					li.classList.add('activ-event-day');
					const now = new Date();
					const isPastEvent = eventsForDay.every(event => {
						const eventDate = new Date(event.date);
						return eventDate < now;
					});
					li.classList.add(isPastEvent ? 'past' : 'future');
					eventsForDay.forEach(event => {
						const eventDate = new Date(event.date);
						const hours = String(eventDate.getHours()).padStart(2, '0');
						const minutes = String(eventDate.getMinutes()).padStart(2, '0');
						const time = `${hours}:${minutes}`;
						const eventLi = document.createElement('div');
						eventLi.classList.add('event-subitem');
						eventLi.innerHTML = `
							<p>${day} - ${event.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'} (${time})</p>
						`;
						li.appendChild(eventLi);
					});
				} else {
					li.classList.add('event-absent');
					li.innerHTML = `<p>${day}</p><p>–ù–µ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –Ω—ñ—è–∫–∞ –ø–æ–¥—ñ—è</p>`;
				}
				eventList.appendChild(li);
			}

			try {
				$.arcticmodal({
					content: '#exampleModal-4'
				});
			} catch (error) {
				console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ (#exampleModal-4):', error);
				alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
			}
		};

		// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
		const calendarInstance = new Cal('divCal');

		// –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ–¥—ñ—ó —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –∫–∞–ª–µ–Ω–¥–∞—Ä
		calendarInstance.fetchEvents().then(() => {
			calendarInstance.showcurr();
		});

		// –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –ø–æ–¥—ñ–π –¥–æ –∫–Ω–æ–ø–æ–∫
		document.getElementById('btnPrev').addEventListener('click', () => calendarInstance.previousMonth());
		document.getElementById('btnNext').addEventListener('click', () => calendarInstance.nextMonth());
		document.querySelector('.podii-2').addEventListener('click', (e) => {
			e.preventDefault();
			calendarInstance.showAllEvents();
		});

		// –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–∞ –≤—Ö–æ–¥—É
		document.querySelector('.menu__registr').addEventListener('click', (e) => {
			e.preventDefault();
			$.arcticmodal({
				content: '#exampleModal-1'
			});
		});

		document.querySelector('.menu__exit').addEventListener('click', (e) => {
			e.preventDefault();
			$.arcticmodal({
				content: '#exampleModal-2'
			});
		});
	</script>
{% endblock %}